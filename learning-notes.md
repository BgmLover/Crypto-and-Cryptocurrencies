#  比特币与数字货币技术学习笔记

[TOC]

## 第二章 关于去中心化

###分布式共识

#### 几个难点

1. 对于死机和恶意节点的处理
2. 点对点网络的不完美，不能保证所有节点都参与进来
3. 信息延迟

####关于拜占庭将军问题

* 简单描述：[wiki](https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98)

  > 一组拜占庭将军分别各率领一支军队共同围困一座城市。为了简化问题，将各支军队的行动策略限定为进攻或撤离两种。因为部分军队进攻部分军队撤离可能会造成灾难性后果，因此各位将军必须通过投票来达成一致策略，即所有军队一起进攻或所有军队一起撤离。因为各位将军分处城市不同方向，他们只能通过信使互相联系。在投票过程中每位将军都将自己投票给进攻还是撤退的信息通过信使分别通知其他所有将军，这样一来每位将军根据自己的投票和其他所有将军送来的信息就可以知道共同的投票结果而决定行动策略。

  系统的问题在于，将军中可能出现[叛徒](https://zh.wikipedia.org/wiki/%E5%8F%9B%E5%BE%92)，他们不仅可能向较为糟糕的策略投票，还可能选择性地发送投票信息。假设有9位将军投票，其中1名叛徒。8名忠诚的将军中出现了4人投进攻，4人投撤离的情况。这时候叛徒可能故意给4名投进攻的将领送信表示投票进攻，而给4名投撤离的将领送信表示投撤离。这样一来在4名投进攻的将领看来，投票结果是5人投进攻，从而发起进攻；而在4名投撤离的将军看来则是5人投撤离。这样各支军队的一致协同就遭到了破坏。

  由于将军之间需要通过信使通讯，叛变将军可能通过伪造信件来以其他将军的身份发送假投票。而即使在保证所有将军忠诚的情况下，也不能排除信使被敌人截杀，甚至被敌人间谍替换等情况。因此很难通过保证人员可靠性及通讯可靠性来解决问题。

  假始那些忠诚（或是没有出错）的将军仍然能通过多数决定来决定他们的战略，便称达到了拜占庭容错。在此，票都会有一个默认值，若消息（票）没有被收到，则使用此默认值来投票。

  上述的故事映射到计算机系统里，将军便成了计算机，而信差就是通信系统。虽然上述的问题涉及了电子化的决策支持与信息安全，却没办法单纯的用[密码学](https://zh.wikipedia.org/wiki/%E5%AF%86%E7%A2%BC%E5%AD%B8)与[数字签名](https://zh.wikipedia.org/wiki/%E6%95%B8%E4%BD%8D%E7%B0%BD%E7%AB%A0)来解决。因为不正常的[电压](https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%A3%93)仍可能影响整个加密过程，这不是密码学与数字签名算法在解决的问题。因此计算机就有可能将错误的结果提交去，亦可能导致错误的决策。

#### 比特币的采取的措施

1. 奖励机制，另一种方式解决共识问题（诚实节点有奖励）
2. 引入随机性（实际系统中达成共识需要1小时左右）

#### 双重支付问题的处理

##### 两种双重支付攻击问题

1. 假设攻击者控制了下一个区块的生成，他可以选择不承认包含初始交易的区块而选择生成新的区块和前一个区块竞争
2. 在区块未确认交易之前商户确认交易，此时用户可以再次发起一次交易来使两次交易竞争

##### 商户的对应策略

* 常见的方法是等待6次确认
* 恶意链难以追上诚实链

### 奖励机制

#### 区块奖励

* 奖励给生成了长期共识链中区块的节点比特币奖励
* 最初每次奖励50比特币，每四年减一半，最后使比特币总量稳定在2100万
* 这是比特币创造的唯一途径

#### 交易费

* 未来的主要奖励机制

### 工作量证明（proof of work）

##### 简单说

* 找一个数nonce -> H(nonce||prev_Hash||data_of_transactions)<target
* 调整target范围来调整平均工作量
* 找一个区块大约要算10^20次

##### 博弈论的观点

* 需要设计这样的协议和激励机制来使得在假设所有矿工以利益最大化为原则的条件下，没有节点可以通过表现不诚实而获得更高的报酬

### 关于51%攻击

#### 产生非法交易

* 不可行，因为计算力并不能解决数字签名的问题

#### 压制其它交易

* 可以拒绝一系列的交易，但是别人也会知道你拒绝了这些交易

#### 改变区块奖励

* 其它人不会认可

#### 影响比特币的被信任程度

* 主要的影响，其它人会因为有人掌握51%以上的计算力而对比特币失去信心

## 第三章 比特币运行机制

#### 比特币交易中的几个概念

1. 地址转换
2. 有效验证
3. 资金合并
4. 共同支付：可以允许多个人共同支付一笔交易
5. 交易语法

#### 比特币的脚本

##### 交易中的输入

关键字段为scriptSIg，包含两部分：

* 签名
* 公钥

##### 交易中的输出

输出包含脚本和地址（公钥的hash）

##### 几个常见脚本命令

1. OP_DUP 复制栈顶数据
2. OP_HASH160 计算两次哈希函数，第一次用SHA-256,第二次用RIPEMD-160
3. OP_EQUALVERIFY检验栈顶两个元素是否相等
4. OP_CHECKSIG检查输入的签名是否有效
5. OP_CHECKMULTISIG检查交易中多个公钥的签名是否有效

##### 签名验证

* message的来源：把当前Transaction的所有TxIn的scriptSig去掉（红色部分），并把当前TxIn的scriptSig替换为UTXO的script（蓝色部分），调整长度字段（绿色部分）： 

![](F:\Bitcoin\note-img\签名验证.jpg)

最后加上小端序4字节的签名类型`0x01`（灰色部分），计算两次SHA256，我们得到message

然后再用椭圆曲线算法来验证即可

##### 销毁证明

使用OP_RETURN脚本即可，保证必定执行且返回错误，这样上一笔比特币就没法使用了

#####pay-to-script-hash

收款方把一个脚本的哈希值提供给付款方作为地址，之后付款方需要提供对应的脚本以及相应的验证。P2SH用于对数据进行hash计算，然后再运行脚本。

### 比特币脚本的应用

##### 第三方交易

可以利用MULTISIG来指定例如“三个人中如果有两个人签名了，资金可以被收取，这时付款方、见证人和收款方只需要其中2人提供签名即可”

##### 锁定时间

利用lock_time这个参数来告诉矿工在记账的时候，要等待t时间之后再把交易记入区块链

##### 智能合约

不依赖第三方，直接利用脚本等工具来实现合约

### 比特币网络

* 3小时没有与其它节点交互，则被认为不再参与

####加入到



